## 非证书登录的缺点

密码登录和密钥登录，都有各自的缺点。

- 密码登录需要输入服务器密码，这非常麻烦，也不安全，存在被暴力破解的风险。

- 密钥登录需要服务器保存用户的公钥，也需要用户保存私钥的指纹。这对于多用户、多服务器的大型机构很不方便，如果有员工离职，需要将他的公钥从每台服务器删除。

## 证书登录是什么？

证书登录就是为了解决上面的缺点而设计的。它引入了一个证书颁发机构（Certificate Authority，简称 CA），对信任的服务器颁发服务器证书，对信任的用户颁发用户证书。

登录时，用户和服务器不需要提前知道彼此的公钥，只需要交换各自的证书，验证是否可信即可。

证书登录的主要优点有两个：

（1）用户和服务器不用交换公钥，这更容易管理，也具有更好的可扩展性。

（2）证书可以设置到期时间，而公钥没有到期时间

## 证书登录的流程

SSH 证书登录之前，如果还没有证书，需要生成证书。具体方法是：

（1）用户和服务器都将自己的公钥，发给 CA；

（2）CA 使用服务器公钥，生成服务器证书，发给服务器；

（3）CA 使用用户的公钥，生成用户证书，发给用户。

有了证书以后，用户就可以登录服务器了。整个过程都是 SSH 自动处理，用户无感知。

- 第一步，用户登录服务器时，SSH 自动将用户证书发给服务器。 
- 第二步，服务器检查用户证书是否有效，以及是否由可信的 CA 颁发。证实以后，就可以信任用户。 
- 第三步，SSH 自动将服务器证书发给用户。 
- 第四步，用户检查服务器证书是否有效，以及是否由信任的 CA 颁发。证实以后，就可以信任服务器。 
- 第五步，双方建立连接，服务器允许用户登录。

## 生成 CA 的密钥

证书登录的前提是，必须有一个 CA，而 CA 本质上就是一对密钥，跟其他密钥没有不同，CA 就用这对密钥去签发证书。

虽然 CA 可以用同一对密钥签发用户证书和服务器证书，但是出于安全性和灵活性，最好用不同的密钥分别签发。所以，CA 至少需要两对密钥，一对是签发用户证书的密钥，假设叫做`user_ca`，另一对是签发服务器证书的密钥，假设叫做`host_ca`。

现在，`~/.ssh`目录应该至少有四把密钥。

- `~/.ssh/user_ca`
- `~/.ssh/user_ca.pub`
- `~/.ssh/host_ca`
- `~/.ssh/host_ca.pub`

## CA 签发服务器证书

签发证书，除了 CA 的密钥以外，还需要服务器的公钥。把服务器公钥`ssh_host_rsa_key.pub`，复制或上传到 CA 所在的服务器。上传以后，CA 就可以使用密钥`host_ca`为服务器的公钥`ssh_host_rsa_key.pub`签发服务器证书。

## CA 签发用户证书

CA 签发用户证书。这时需要用户的公钥，将用户公钥`user_key.pub`，上传或复制到 CA 服务器。接下来，就可以使用 CA 的密钥`user_ca`为用户公钥`user_key.pub`签发用户证书。

## 服务器安装证书

CA 生成服务器证书`ssh_host_rsa_key-cert.pub`以后，需要将该证书发回服务器，然后，添加到服务器配置文件

## 服务器安装 CA 公钥

为了让服务器信任用户证书，必须将 CA 签发用户证书的公钥`user_ca.pub`，拷贝到服务器。 服务器的所有账户都会信任`user_ca`签发的所有用户证书

## 客户端安装证书

客户端安装用户证书很简单，就是从 CA 将用户证书`user_key-cert.pub`复制到客户端，与用户的密钥`user_key`保存在同一个目录即可。

## 客户端安装 CA 公钥

为了让客户端信任服务器证书，必须将 CA 签发服务器证书的公钥`host_ca.pub`，加到客户端里

## 废除证书

废除证书的操作，分成用户证书的废除和服务器证书的废除两种。